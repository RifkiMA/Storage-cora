<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Cloud Storage</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">

    <h2>NEON CLOUD STORAGE</h2>

    <div class="upload-card">
        <label for="fileInput" class="upload-label" style="display:block; width:100%; height:100%;">
            <span class="icon">‚òÅÔ∏è</span>
            Pilih File untuk Upload
        </label>
        <input type="file" id="fileInput" hidden>
    </div>

    <div id="progressBox" class="progress-box hidden">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <h3>Daftar File</h3>
    <div id="fileList" class="file-list">
        <p style="grid-column: span 2; text-align: center; color: #a1a1aa;">Memuat data...</p>
    </div>

</div>

<script>
    // --- 1. KONFIGURASI SUPABASE (SUDAH DIPASANG) ---
    const SUPABASE_URL = "https://tolpssxxrmxpavchvboj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvbHBzc3h4cm14cGF2Y2h2Ym9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNjQ4NzQsImV4cCI6MjA4MDk0MDg3NH0.KUNevhVtgsutkYGKb9OQ8QJXkiJcR_Zq1HVbeeiCsyM";

    // Inisialisasi Client
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM Elements
    const fileInput = document.getElementById("fileInput");
    const progressBox = document.getElementById("progressBox");
    const progressBar = document.getElementById("progressBar");
    const fileList = document.getElementById("fileList");

    // --- 2. UPLOAD FILE ---
    fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        if (!file) return;

        progressBox.classList.remove("hidden");
        progressBar.style.width = "30%"; // Simulasi loading awal

        try {
            // A. Upload ke Storage Bucket "files"
            // Kita bersihkan nama file dari spasi agar link-nya aman
            const cleanName = file.name.replace(/\s+/g, '_');
            const fileName = Date.now() + "_" + cleanName;
            
            const { data, error } = await _supabase
                .storage
                .from('files') // Pastikan nama bucket di Supabase adalah 'files'
                .upload(fileName, file);

            if (error) throw error;

            progressBar.style.width = "70%";

            // B. Ambil URL Publik agar bisa dilihat orang lain
            const { data: publicData } = _supabase
                .storage
                .from('files')
                .getPublicUrl(fileName);
            
            const publicURL = publicData.publicUrl;

            // C. Simpan Info ke Tabel Database "uploads"
            const { error: dbError } = await _supabase
                .from('uploads') // Pastikan nama tabel di Supabase adalah 'uploads'
                .insert([
                    { 
                        file_name: file.name, 
                        file_url: publicURL,
                        file_type: file.type 
                    }
                ]);

            if (dbError) throw dbError;

            // D. Selesai
            progressBar.style.width = "100%";
            
            setTimeout(() => {
                progressBox.classList.add("hidden");
                fileInput.value = "";
                loadFiles(); // Refresh list otomatis
            }, 1000);

        } catch (err) {
            console.error("Upload Error:", err);
            alert("Gagal Upload: " + err.message);
            progressBox.classList.add("hidden");
        }
    });

    // --- 3. LOAD FILES ---
    async function loadFiles() {
        fileList.innerHTML = "";
        
        // Ambil data dari tabel "uploads", urutkan dari yang terbaru (created_at desc)
        const { data, error } = await _supabase
            .from('uploads')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Gagal memuat data:", error);
            fileList.innerHTML = "<p style='color:red; text-align:center;'>Gagal koneksi database.</p>";
            return;
        }

        if (!data || data.length === 0) {
            fileList.innerHTML = "<p style='grid-column: span 2; text-align: center; color: #a1a1aa;'>Belum ada file.</p>";
            return;
        }

        // Render setiap file ke layar
        data.forEach(f => {
            const item = document.createElement("div");
            item.className = "file-item";
            
            let previewHTML = "";
            const fileUrl = f.file_url;
            const fileName = f.file_name;
            const fileType = f.file_type || "";

            // Deteksi Tipe File untuk Preview
            if (fileType.startsWith("image/") || fileName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                previewHTML = `<div class="preview"><img src="${fileUrl}" loading="lazy"></div>`;
            } else if (fileType.startsWith("video/") || fileName.match(/\.(mp4|webm)$/i)) {
                previewHTML = `<div class="preview"><video src="${fileUrl}" controls></video></div>`;
            } else if (fileType.startsWith("audio/") || fileName.match(/\.(mp3|wav)$/i)) {
                previewHTML = `<div class="preview preview-audio"><div class="audio-icon">üéµ</div><audio controls src="${fileUrl}"></audio></div>`;
            } else {
                let icon = "üìÑ";
                if (fileName.match(/\.pdf$/i)) icon = "üìï";
                if (fileName.match(/\.(zip|rar)$/i)) icon = "üì¶";
                previewHTML = `<div class="preview preview-file"><div class="file-icon-large">${icon}</div></div>`;
            }

            item.innerHTML = `
                <div class="file-content">
                    ${previewHTML}
                    <span class="file-name" title="${fileName}">${fileName}</span>
                </div>
                <a href="${fileUrl}" target="_blank" class="file-btn" style="text-align:center; text-decoration:none; display:block;">Download</a>
            `;
            fileList.appendChild(item);
        });
    }

    // Load saat pertama kali web dibuka
    loadFiles();
</script>

</body>
</html>
